<script type="text/javascript">

    RED.nodes.registerType('Login',{
      category: 'config',
      defaults: {
          name: {value:""},
          autoLogin: {value:false},
          proxyHost: {value:"", required:false},
          proxyPort: {value:"", required:false},
          proxyProto: {value:"", required:false},
          ackIM: {value:false},
      },
      credentials: {
           username: {type:"text", required:true},
           password: {type:"password", required:true}
      },
      label: function() {
          return this.name||"Login";
      },
    });

    RED.nodes.registerType('Send_IM',{
        category: 'ALE Rainbow',
        color: '#a6bbcf',
        defaults: {
            server: {value:"", type:"Login"},
            name: {value:""},
            destJid: {value:"", required:false }
        },
        inputs:1,
        outputs:0,
        icon: "rainbow.png",
        label: function() {
            return this.name||"Send_IM";
        }
    });

    RED.nodes.registerType('Notified_IM',{
        category: 'ALE Rainbow',
        color: '#a6bbcf',
        defaults: {
            server: {value:"", type:"Login"},
            name: {value:""},
            filter: {value:"", required:false}
        },
        inputs:0,
        outputs:1,
        icon: "rainbow.png",
        label: function() {
            return this.name||"Notified_IM";
        }
    });

    RED.nodes.registerType('Notified_IM_Read',{
        category: 'ALE Rainbow',
        color: '#a6bbcf',
        defaults: {
            server: {value:"", type:"Login"},
            name: {value:""},
            filter: {value:"", required:false}
        },
        inputs:0,
        outputs:1,
        icon: "rainbow.png",
        label: function() {
            return this.name||"Notified_IM_Read";
        }
    });

    RED.nodes.registerType('Ack_IM_Read',{
        category: 'ALE Rainbow',
        color: '#a6bbcf',
        defaults: {
            server: {value:"", type:"Login"},
            name: {value:""},
        },
        inputs:1,
        outputs:0,
        icon: "rainbow.png",
        label: function() {
            return this.name||"Ack_IM_Read";
        }
    });
    RED.nodes.registerType('Notified_Presence',{
        category: 'ALE Rainbow',
        color: '#a6bbcf',
        defaults: {
            server: {value:"", type:"Login"},
            name: {value:""},
            filter: {value:"", required:false}
        },
        inputs:0,
        outputs:1,
        icon: "rainbow.png",
        label: function() {
            return this.name||"Notified_Presence";
        }
    });

    RED.nodes.registerType('Set_Presence',{
        category: 'ALE Rainbow',
        color: '#a6bbcf',
        defaults: {
            server: {value:"", type:"Login"},
            name: {value:""},
        },
        inputs:1,
        outputs:0,
        icon: "rainbow.png",
        label: function() {
            return this.name||"Set_Presence";
        }
    });

    RED.nodes.registerType('CnxState',{
        category: 'ALE Rainbow',
        color: '#a6bbcf',
        defaults: {
            server: {value:"", type:"Login"},
            name: {value:""},
        },
        inputs:1,
        outputs:1,
        icon: "rainbow.png",
        label: function() {
            return this.name||"CnxState";
        },
        button: {
            onclick: function() {
                var node = this;
                $.ajax({
                    url: "Login/"+this.id,
                    type:"POST",
                    success: function(resp) {
                        RED.notify(node._("CnxState.success",{label:label}),"success");
                    },
                    error: function(jqXHR,textStatus,errorThrown) {
                        if (jqXHR.status == 404) {
                            RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.not-deployed")}),"error");
                        } else if (jqXHR.status == 500) {
                            RED.notify(node._("common.notification.error",{message:node._("inject.errors.failed")}),"error");
                        } else if (jqXHR.status == 0) {
                            RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.no-response")}),"error");
                        } else {
                            RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.unexpected",{status:jqXHR.status,message:textStatus})}),"error");
                        }
                    }
                });
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="Send_IM">
    <div class="form-row">
      <label for="node-input-server"><i class="icon-tag"></i> Rainbow Broker</label>
      <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
      <label for="node-input-destJid"><i class="icon-tag"></i> Destination JID</label>
      <input type="text" id="node-input-destJid" placeholder="Full JID here">
    </div>
</script>

<script type="text/x-red" data-help-name="Send_IM">
    <p>Send a instant message to a Rainbow identity</br>
    <b>Properties :</b><br>
    <li>Property <b>JID Destination</b> is the full JID of the default receipient.<br>
    (unless <b>msg.payload.destJid</b> is defined)</p>
    <b>Input :</b><br>
    <li><b>msg.payload.content</b> should contain a plain text IM (as a string).<br>
    <li><b>msg.payload.destJid</b> should contain full JID os the receipient (optional).<br>
    </p>
</script>

<script type="text/x-red" data-template-name="Notified_IM">
    <div class="form-row">
      <label for="node-input-server"><i class="icon-tag"></i> Rainbow Broker</label>
      <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
      <label for="node-input-filter"><i class="icon-tag"></i> RegExp Filter</label>
      <input type="text" id="node-input-filter" placeholder="RexExp Here">
    </div>
</script>

<script type="text/x-red" data-help-name="Notified_IM">
    <p>Get a instant message to a Rainbow identity
    <b>Output :</b><br>
    <b>msg.payload</b> contains :<br>
      <li><b>fromJid</b> : JID of the originator of the IM,<br>
      <li><b>content</b> : IM content</br>
    </p>
</script>

<script type="text/x-red" data-template-name="Notified_IM_Read">
    <div class="form-row">
      <label for="node-input-server"><i class="icon-tag"></i> Rainbow Broker</label>
      <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
      <label for="node-input-filter"><i class="icon-tag"></i> RegExp Filter</label>
      <input type="text" id="node-input-filter" placeholder="RexExp Here">
    </div>
</script>

<script type="text/x-red" data-help-name="Notified_IM_Read">
    <p>Get notifies when a message has been read by distant</p>
</script>

<script type="text/x-red" data-template-name="Ack_IM_Read">
    <div class="form-row">
      <label for="node-input-server"><i class="icon-tag"></i> Rainbow Broker</label>
      <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="Ack_IM_Read">
    <p>Ack (mark as read) IM received.<br>
    <b>Input :</b><br>
    <li><b>msg.payload</b> should contain the complete message received with Notified_IM node.<br>
    <b>Node :</b><br>
    Race condition could occured. It is highly recommanded to add delay between IM reception and ack.<br>
    </p>
</script>

<script type="text/x-red" data-template-name="Notified_Presence">
    <div class="form-row">
      <label for="node-input-server"><i class="icon-tag"></i> Rainbow Broker</label>
      <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
      <label for="node-input-filter"><i class="icon-tag"></i> RegExp Filter</label>
      <input type="text" id="node-input-filter" placeholder="RexExp Here">
    </div>
</script>

<script type="text/x-red" data-help-name="Notified_Presence">
    <p>Get presence update of contacts<br>
    <b>Output :</b><br>
    <b>msg.payload</b> contains :<br>
      <li><b>loginemail</b> : loginEmail address of the contact,<br>
      <li><b>displayname</b> : plain text display name of the contact,<br>
      <li><b>fromJid</b> : JID of the contact of the IM,<br>
      <li><b>presence</b> : presence of the contact (string), can be 'online', 'offline', 'busy', 'xa' or 'away'. 'xa' means do not disturb.<br>
      <li><b>status</b> : additional presence information : can be 'presentation', 'phone', 'audio', 'video' or 'sharing' when presence is 'busy', can be 'mobile' when presence is 'online'.
    </p>
</script>

<script type="text/x-red" data-template-name="Set_Presence">
    <div class="form-row">
      <label for="node-input-server"><i class="icon-tag"></i> Rainbow Broker</label>
      <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="Set_Presence">
    <p>Set own presence<br>
    <b>Output :</b><br>
    <b>msg.payload</b> must contains :<br>
      <li><b>payload</b> : fill with either 'online', 'dnd', 'away' or 'invisible'<br>
    </p>
</script>

<script type="text/x-red" data-template-name="CnxState">
    <div class="form-row">
      <label for="node-input-server"><i class="icon-tag"></i> Rainbow Broker</label>
      <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
      <label for="node-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Name">
    </div>
</script>

<script type="text/x-red" data-help-name="CnxState">
    <p>Get connection state to Rainbow Cloud services<br>
    <b>Input :</b><br>
    <b>msg.payload</b> contains connection request (string).<br>
    It can be :<br>
      <li><b>'login'</b> : triggers Rainbow sign-in procedure<br>
      <li><b>'logout'</b> : triggers Rainbow sign-out procedure<br>
    </p>
    <b>Output :</b><br>
    <b>msg.payload</b> contains connection status (string).<br>
    It can be :<br>
      <li><b>'rainbow_onconnectionok'</b> : Fired when the connection is successfull with Rainbow (signin complete)<br>
      <li><b>'rainbow_onready'</b> : Fired when the SDK is connected to Rainbow and ready to be used<br>
      <li><b>'rainbow_onconnectionerror'</b> :  Fired when the connection can t be done with Rainbow (ie. issue on sign-in) <br>
      <li><b>'rainbow_onerror'</b> : Fired when something goes wrong (ie: bad 'configurations' parameter...)
    </p>
</script>

<script type="text/x-red" data-template-name="Login">
    <div class="form-row">
      <label for="node-config-input-name"><i class="icon-tag"></i> Name</label>
      <input type="text" id="node-config-input-name" placeholder="Name">
    </div>
    <div class="form-row">
         <label for="node-config-input-username"><i class="icon-tag"></i> Username</label>
         <input type="text" id="node-config-input-username">
     </div>
     <div class="form-row">
         <label for="node-config-input-password"><i class="icon-tag"></i> Password</label>
         <input type="password" id="node-config-input-password">
     </div>
     <div class="form-row">
          <label for="node-config-input-autoLogin"><i class="icon-tag"></i> Automatic Login</label>
          <input type="checkbox" id="node-config-input-autoLogin">
      </div>
     <div class="form-row">
         <label for="node-config-input-proxyHost"><i class="icon-tag"></i> Proxy Host</label>
         <input type="text" id="node-config-input-proxyHost" placeholder="Proxy IP or FQDN">
     </div>
     <div class="form-row">
         <label for="node-config-input-proxyPort"><i class="icon-tag"></i> Proxy Port</label>
         <input type="text" id="node-config-input-proxyPort" placeholder="Proxy Port">
     </div>
     <div class="form-row">
         <label for="node-config-input-proxyProto"><i class="icon-tag"></i> Proxy Protocol</label>
         <input type="text" id="node-config-input-proxyProto" placeholder="http or https">
     </div>
     <div class="form-row">
          <label for="node-config-input-ackIM"><i class="icon-tag"></i> Automatic acknowledge of incoming IM</label>
          <input type="checkbox" id="node-config-input-ackIM">
      </div>
</script>

<script type="text/x-red" data-help-name="Login">
    <p>Login to Rainbow with your identity<br>
</script>
